{% extends 'base.html' %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-12">
            <h1>My Recipes</h1>
            
            <!-- Navigation Tabs -->
            <ul class="nav nav-tabs" id="recipeTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="saved-tab" data-bs-toggle="tab" data-bs-target="#saved-recipes" 
                            type="button" role="tab" aria-controls="saved-recipes" aria-selected="true">
                        Saved Recipes ({{ saved_recipes.count }})
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="created-tab" data-bs-toggle="tab" data-bs-target="#created-recipes" 
                            type="button" role="tab" aria-controls="created-recipes" aria-selected="false">
                        My Created Recipes ({{ created_recipes.count }})
                    </button>
                </li>
            </ul>
            
            <!-- Tab Content -->
            <div class="tab-content" id="recipeTabContent">
                <!-- Saved Recipes Tab -->
                <div class="tab-pane fade show active" id="saved-recipes" role="tabpanel" aria-labelledby="saved-tab">
                    <div class="mt-3">
                        {% if saved_recipes %}
                            <p>You have {{ saved_recipes.count }} saved recipe(s) from your searches.</p>
                            
                            <div class="saved-recipes-grid">
                                {% for library_entry in saved_recipes %}
                                    <div class="recipe-card">
                                        <h3>{{ library_entry.recipe.title }}</h3>
                                        <img src="https://spoonacular.com/recipeImages/{{ library_entry.recipe.recipe_id }}-312x231.jpg" 
                                             alt="{{ library_entry.recipe.title }}" style="max-width: 100%; border-radius: 5px;">
                                        <p><small>Saved on: {{ library_entry.created_at|date:"F d, Y" }}</small></p>
                                        
                                        {% if library_entry.is_shared %}
                                            <span class="badge bg-success">✓ Shared to Feed</span>
                                        {% endif %}
                                        
                                        <div class="button-group" style="margin-top: 1rem;">
                                            <a href="{% url 'recipe_detail' library_entry.recipe.recipe_id %}" class="btn btn-primary">View Recipe</a>
                                            
                                            <!-- Share Button -->
                                            <button type="button" class="btn btn-info" data-bs-toggle="modal" 
                                                    data-bs-target="#shareModal{{ library_entry.recipe.recipe_id }}">
                                                {% if library_entry.is_shared %}Update Share{% else %}Share{% endif %}
                                            </button>
                                            
                                            <!-- Delete Button -->
                                            <button type="button" class="btn btn-danger" data-bs-toggle="modal" 
                                                    data-bs-target="#deleteModal{{ library_entry.recipe.recipe_id }}">
                                                Delete
                                            </button>
                                        </div>

                                        <!-- Share Modal -->
                                        <div class="modal fade" id="shareModal{{ library_entry.recipe.recipe_id }}" tabindex="-1">
                                            <div class="modal-dialog">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <h5 class="modal-title">Share {{ library_entry.recipe.title }}</h5>
                                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                                    </div>
                                                    <form method="POST" action="{% url 'share_recipe' library_entry.recipe.recipe_id %}">
                                                        {% csrf_token %}
                                                        <div class="modal-body">
                                                            <div class="mb-3">
                                                                <label for="message{{ library_entry.recipe.recipe_id }}" class="form-label">
                                                                    Add a message (optional):
                                                                </label>
                                                                <textarea name="message" id="message{{ library_entry.recipe.recipe_id }}" 
                                                                          class="form-control" rows="3" 
                                                                          placeholder="Share your thoughts...">{{ library_entry.message }}</textarea>
                                                            </div>
                                                            <div class="mb-3">
                                                                <label for="rating{{ library_entry.recipe.recipe_id }}" class="form-label">
                                                                    Rating (optional):
                                                                </label>
                                                                <select name="rating" id="rating{{ library_entry.recipe.recipe_id }}" class="form-select">
                                                                    <option value="">No rating</option>
                                                                    <option value="5" {% if library_entry.rating == 5 %}selected{% endif %}>⭐⭐⭐⭐⭐ (5 stars)</option>
                                                                    <option value="4" {% if library_entry.rating == 4 %}selected{% endif %}>⭐⭐⭐⭐ (4 stars)</option>
                                                                    <option value="3" {% if library_entry.rating == 3 %}selected{% endif %}>⭐⭐⭐ (3 stars)</option>
                                                                    <option value="2" {% if library_entry.rating == 2 %}selected{% endif %}>⭐⭐ (2 stars)</option>
                                                                    <option value="1" {% if library_entry.rating == 1 %}selected{% endif %}>⭐ (1 star)</option>
                                                                </select>
                                                            </div>
                                                        </div>
                                                        <div class="modal-footer">
                                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                                            <button type="submit" class="btn btn-primary">Share to Feed</button>
                                                        </div>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Delete Modal -->
                                        <div class="modal fade" id="deleteModal{{ library_entry.recipe.recipe_id }}" tabindex="-1">
                                            <div class="modal-dialog">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <h5 class="modal-title">Confirm Deletion</h5>
                                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                                    </div>
                                                    <div class="modal-body">
                                                        Are you sure you want to delete <strong>{{ library_entry.recipe.title }}</strong> from your library?
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                                        <form method="POST" action="{% url 'delete_recipe' library_entry.recipe.recipe_id %}" style="display:inline;">
                                                            {% csrf_token %}
                                                            <button type="submit" class="btn btn-danger">Delete</button>
                                                        </form>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="text-center py-5">
                                <h4>No Saved Recipes Yet</h4>
                                <p class="text-muted">Search for recipes and save your favorites!</p>
                                <a href="{% url 'search_recipes' %}" class="btn btn-primary">Search for Recipes</a>
                            </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Created Recipes Tab -->
                <div class="tab-pane fade" id="created-recipes" role="tabpanel" aria-labelledby="created-tab">
                    <div class="mt-3">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                {% if created_recipes %}
                                    <p>You have created {{ created_recipes.count }} original recipe(s).</p>
                                {% endif %}
                            </div>
                            <a href="{% url 'create_recipe' %}" class="btn btn-success">
                                <i class="bi bi-plus-lg"></i> Create New Recipe
                            </a>
                        </div>
                        
                        {% if created_recipes %}
                            <div class="row">
                                {% for recipe in created_recipes %}
                                <div class="col-md-6 col-lg-4 mb-4">
                                    <div class="card h-100">
                                        {% if recipe.featured_image %}
                                            <img src="{{ recipe.featured_image.url }}" class="card-img-top" alt="{{ recipe.title }}" style="height: 200px; object-fit: cover;">
                                        {% else %}
                                            <div class="card-img-top bg-light d-flex align-items-center justify-content-center" style="height: 200px;">
                                                <span class="text-muted">No Image</span>
                                            </div>
                                        {% endif %}
                                        
                                        <div class="card-body d-flex flex-column">
                                            <h5 class="card-title">{{ recipe.title }}</h5>
                                            
                                            {% if recipe.description %}
                                            <p class="card-text">{{ recipe.description|truncatewords:20 }}</p>
                                            {% endif %}
                                            
                                            <div class="recipe-meta mb-2">
                                                {% if recipe.servings %}
                                                <small class="text-muted">
                                                    <i class="bi bi-people"></i> {{ recipe.servings }} servings
                                                </small>
                                                {% endif %}
                                                
                                                {% if recipe.ready_in_minutes %}
                                                <small class="text-muted ms-2">
                                                    <i class="bi bi-clock"></i> {{ recipe.ready_in_minutes }} mins
                                                </small>
                                                {% endif %}
                                            </div>
                                            
                                            <small class="text-muted mb-3">Created {{ recipe.created_at|timesince }} ago</small>
                                            
                                            <div class="mt-auto">
                                                <div class="btn-group w-100" role="group">
                                                    <a href="{% url 'created_recipe_detail' recipe.id %}" class="btn btn-primary">View</a>
                                                    <a href="{% url 'edit_created_recipe' recipe.id %}" class="btn btn-outline-secondary">Edit</a>
                                                    <a href="{% url 'delete_created_recipe' recipe.id %}" class="btn btn-outline-danger" 
                                                       onclick="return confirm('Are you sure you want to delete this recipe?')">Delete</a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="text-center py-5">
                                <h4>No Created Recipes Yet</h4>
                                <p class="text-muted">Start by creating your first original recipe!</p>
                                <a href="{% url 'create_recipe' %}" class="btn btn-success">Create Your First Recipe</a>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
